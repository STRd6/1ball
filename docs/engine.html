<!DOCTYPE html>

<html>
<head>
  <title>engine</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="http://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
        
        
        <li id="section-1">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="engine">Engine</h1>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            <div class="content"><pre><code class="lang-coffeescript">Compositions = require <span class="string">"./lib/compositions"</span>
Hotkeys = require <span class="string">"./hotkeys"</span>

Ball = require <span class="string">"./ball"</span>
Chapters = require <span class="string">"./levels"</span>
Pin = require <span class="string">"./pin"</span>
Physics = require <span class="string">"./physics"</span>
{Size} = require <span class="string">"./lib/util"</span>

<span class="comment"># ⚀</span>
module.<span class="function"><span class="title">exports</span></span> = (I={}, self=Core(I)) -&gt;
  Object.defaults I,
    age: <span class="number">0</span>
    chapter: <span class="number">0</span>
    levelName: <span class="string">"⚀"</span>
    pins: [
      {}
    ]
    startZone: <span class="number">100</span>

  self.include Compositions
  self.include Hotkeys
  self.include Physics

  self.attrAccessor <span class="string">"age"</span>, <span class="string">"levelName"</span>

  self.attrModel <span class="string">"ball"</span>, Ball
  self.attrModel <span class="string">"size"</span>, Size
  self.attrModels <span class="string">"pins"</span>, Pin

  instructions = <span class="string">"""
    Click and Drag

    'r' to Restart Level
  """</span>

  restartText = <span class="string">"""
    Oops, didn't hit them all!

    Press 'r' to restart level
  """</span>

  startPosition = currentPosition = <span class="literal">null</span>

  <span class="function"><span class="title">getPower</span></span> = (a, b) -&gt;
    p = Point.distance(a, b) / <span class="number">200</span>

    p.clamp <span class="number">0</span>, <span class="number">1</span>

  gameOver = <span class="literal">false</span>

  fadeStart = -<span class="number">1</span>
  resetAt = <span class="number">0</span>
  fadeEnd = <span class="number">1</span>

  resetCount = <span class="number">0</span>
  skippableAt = <span class="number">7</span>

  <span class="function"><span class="title">outOfBounds</span></span> = (object) -&gt;
    p = object.position()

    (p.x &lt; <span class="number">0</span> <span class="keyword">or</span> p.x &gt; self.size().width) <span class="keyword">or</span>
    (p.y &lt; <span class="number">0</span> <span class="keyword">or</span> p.y &gt; self.size().height)

  self.extend
    levelDisplayName: -&gt;
      <span class="string">"<span class="subst">#{I.chapter + <span class="number">1</span>}</span> - <span class="subst">#{self.levelName()}</span>"</span>

    levelNames: -&gt;
      names = Object.keys(Chapters[I.chapter])

      <span class="keyword">return</span> names

    currentLevelData: -&gt;
      Chapters[I.chapter][self.levelName()]()

    resetLevel: -&gt;
      resetCount += <span class="number">1</span>
      gameOver = <span class="literal">false</span>
      self.ball(<span class="literal">null</span>)

      <span class="comment"># Reset pins</span>
      self.pins self.currentLevelData()

    goToLevel: (name) -&gt;
      <span class="keyword">return</span> <span class="keyword">if</span> fadeStart

      <span class="comment"># TODO: AFTER COMPO: This is all gross</span>
      fadeStart = I.age
      resetAt = I.age + <span class="number">1</span>
      fadeEnd = I.age + <span class="number">2</span>

      <span class="keyword">if</span> name
        <span class="comment"># Jump to a level by name</span>
      <span class="keyword">else</span>
        nextIndex = self.levelNames().indexOf(I.levelName) + <span class="number">1</span>
        name = self.levelNames()[nextIndex]

      <span class="keyword">if</span> name
        I.levelName = name
      <span class="keyword">else</span>
        self.nextChapter()

    nextChapter: -&gt;
      I.chapter += <span class="number">1</span>

      <span class="keyword">if</span> Chapters[I.chapter]
        name = self.levelNames().first()
        I.levelName = name
        self.goToLevel name
      <span class="keyword">else</span>
        <span class="comment"># TODO: Better winning message</span>
        alert <span class="string">"a winner is you"</span>

    touch: (position) -&gt;
      <span class="comment"># Check for skip button</span>
      <span class="keyword">if</span> (p = position.scale(self.size())) <span class="keyword">and</span> (resetCount &gt;= skippableAt)
        <span class="keyword">if</span> <span class="number">0</span> &lt;= p.x &lt;= <span class="number">100</span>
          <span class="keyword">if</span> <span class="number">0</span> &lt;= p.y &lt;= <span class="number">30</span>
            self.goToLevel() <span class="comment"># Skip it!</span>

      <span class="keyword">unless</span> self.ball()
        startPosition = currentPosition = position.scale(self.size())

        startPosition.x = startPosition.x.clamp(<span class="number">0</span>, I.startZone)

    move: (position) -&gt;
      currentPosition = position.scale(self.size())

    release: (position) -&gt;
      <span class="keyword">if</span> startPosition
        currentPosition = position.scale(self.size())

        self.fire startPosition, currentPosition

        startPosition = currentPosition = <span class="literal">null</span>

    fire: (start, target) -&gt;
      self.ball Ball
        position: start
        velocity: target.subtract(start).norm getPower(start, target) * <span class="number">1600</span> + <span class="number">1</span>

    objects: -&gt;
      <span class="keyword">if</span> self.ball()
        self.pins().concat(self.ball())
      <span class="keyword">else</span>
        self.pins()

    shouldRestart: -&gt;
      <span class="keyword">if</span> self.ball()
        <span class="keyword">if</span> outOfBounds self.ball()
          self.pins().reduce (restart, pin) -&gt;
            restart <span class="keyword">and</span> !(pin.hit() <span class="keyword">and</span> !outOfBounds(pin))
          , <span class="literal">true</span>

    update: (dt) -&gt;
      <span class="keyword">if</span> I.age &gt; resetAt
        resetAt = <span class="literal">undefined</span>
        resetCount = <span class="number">0</span>
        self.resetLevel()

      <span class="keyword">if</span> I.age &gt; fadeEnd
        fadeStart = fadeEnd = <span class="literal">null</span>

      <span class="keyword">unless</span> gameOver
        self.processPhysics(self.objects(), dt)

        done = self.pins().reduce (done, pin) -&gt;
          done <span class="keyword">and</span> pin.hit()
        , <span class="literal">true</span>

        <span class="keyword">if</span> done
          self.goToLevel() <span class="comment"># Next level</span>

      I.age += dt

    drawMessage: (message, canvas) -&gt;
      message.split(<span class="string">"\n"</span>).map (text, i) -&gt;
        canvas.font <span class="string">"40px bold 'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif"</span>

        canvas.centerText
          color: <span class="string">"pink"</span>
          position: Point(<span class="number">0.5</span>, <span class="number">0.5</span>).scale(self.size()).add Point(<span class="number">0</span>, <span class="number">50</span> * (i - <span class="number">1</span>) )
          text: text

    draw: (canvas) -&gt;
      canvas.fill(<span class="string">"red"</span>)
      canvas.fill
        x: <span class="number">0</span>
        y: <span class="number">0</span>
        width: I.startZone
        height: self.size().height
        color: <span class="string">"gray"</span>

      <span class="keyword">if</span> startPosition
        power = getPower(startPosition, currentPosition)

        canvas.drawCircle
          x: startPosition.x
          y: startPosition.y
          color: <span class="string">"blue"</span>
          radius: <span class="number">64</span>

        canvas.drawLine
          start: startPosition
          end: currentPosition
          color: <span class="string">"black"</span>

        fontSize = <span class="number">32</span> + <span class="number">6</span> * Math.sin(self.age() * <span class="number">1.5</span> * Math.TAU)
        canvas.font <span class="string">"<span class="subst">#{fontSize}</span>px bold 'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif"</span>
        canvas.centerText
          color: <span class="string">"white"</span>
          position: currentPosition
          text: (power * <span class="number">100</span>).toFixed(<span class="number">2</span>)
      <span class="keyword">else</span> <span class="keyword">if</span> self.ball()
        self.ball().draw canvas
      <span class="keyword">else</span> <span class="keyword">if</span> mousePosition
        canvas.drawCircle
          x: mousePosition.x
          y: mousePosition.y
          color: <span class="string">"blue"</span>
          radius: <span class="number">64</span>

      self.pins.forEach (pin) -&gt;
        pin.draw(canvas)

      <span class="keyword">if</span> fadeStart
        x = (I.age - fadeStart) / (fadeEnd - fadeStart) * <span class="number">2</span>
        opacity = (-(x - <span class="number">1</span>) * (x - <span class="number">1</span>) + <span class="number">1</span>).clamp(<span class="number">0</span>, <span class="number">1</span>)
        canvas.fill <span class="string">"rgba(0, 0, 0, <span class="subst">#{opacity.toFixed(<span class="number">8</span>)}</span>)"</span>

      <span class="keyword">if</span> resetCount &gt;= skippableAt
        fontSize = <span class="number">32</span> + <span class="number">6</span> * Math.sin(self.age() * <span class="number">1.5</span> * Math.TAU)
        canvas.font <span class="string">"<span class="subst">#{fontSize}</span>px bold 'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif"</span>

        canvas.drawText
          position:
            x: <span class="number">10</span>
            y: <span class="number">30</span>
          text: <span class="string">"Skip"</span>

      <span class="keyword">if</span> I.age &lt; <span class="number">5</span>
        self.drawMessage instructions, canvas
      <span class="keyword">else</span> <span class="keyword">if</span> self.shouldRestart() <span class="keyword">and</span> !fadeStart
        self.drawMessage restartText, canvas 

      <span class="comment"># Level Name</span>
      displayName = self.levelDisplayName()
      canvas.font <span class="string">"40px bold 'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif"</span>
      canvas.drawText
        color: <span class="string">"white"</span>
        text: displayName
        position:
          x: self.size().width - canvas.measureText(displayName) - <span class="number">20</span>
          y: self.size().height - <span class="number">20</span>

  <span class="comment"># Hack for gosting on pointer devices</span>
  mousePosition = <span class="literal">null</span>

  $(<span class="string">"body"</span>).<span class="literal">on</span> <span class="string">"mousemove"</span>, (e) -&gt;
    mousePosition = localPosition(e)
    mousePosition.x = mousePosition.x.clamp(<span class="number">0</span>, I.startZone)

  <span class="function"><span class="title">localPosition</span></span> = (e) -&gt;
    $currentTarget = $(<span class="string">"canvas"</span>)
    offset = $currentTarget.offset()

    point = Point(
      (e.pageX - offset.left)
      (e.pageY - offset.top)
    )

    <span class="keyword">return</span> point

  self.goToLevel()

  <span class="keyword">return</span> self</code></pre>
</div>
        </li>
        
    </ul>
  </div>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<script src="http://strd6.github.io/require/v0.2.2.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://strd6.github.io/tempest/javascripts/envweb-v0.4.5.js"></script><script>
  $.ajax({
    url: "http://strd6.github.io/interactive/v0.8.1.jsonp",
    dataType: "jsonp",
    jsonpCallback: "STRd6/interactive:v0.8.1",
    cache: true
  }).then(function(PACKAGE) {
    Require.generateFor(PACKAGE)("./" + PACKAGE.entryPoint)
  })
</script><script src="package.js"></script>
</body>
</html>